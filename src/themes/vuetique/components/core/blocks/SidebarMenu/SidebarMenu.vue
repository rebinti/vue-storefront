<template>
  <div class="sidebar-menu h-screen fixed max-w-full bg-white pt-12">
    <button
      type="button"
      :aria-label="$t('Close')"
      class="absolute top-0 right-0 m-4 h-4"
      @click="closeMenu"
    >

      <svg viewBox="0 0 25 25" class="vt-icon--sm">
        <use xlink:href="#close" />
      </svg>
    </button>

    <div v-if="submenu.depth && !isUserInAccountsPageFlag" class="absolute left-0 top-0">
      <sub-btn type="back" />
    </div>

    <ul class="relative border-t sidebar-menu__list" :style="mainListStyles">
      <li @click="closeMenu" class="flex border-b menu_li_it hide-item-full" >
         <router-link
            v-if="currentUser"
            class="category-link"
            :to="localizedRoute('/my-account-menu')"
          >
            MY ACCOUNT
          </router-link>
        <a
          v-if="!currentUser && isCurrentMenuShowed"
          href="#"
          @click.prevent="login"
          class="menu-link"
        >
         MY ACCOUNT
        </a>
      </li>
      <li
        class="border-b flex menu_li_it"
        :key="category.slug"
        @click="closeMenu"
        v-for="category in visibleCategories"
      >
        <div v-if="isCurrentMenuShowed" class="w-full">
          
          <sub-btn
            :id="category.id"
            :name="category.name"
            :thumbnail="category.thumbnail"
            v-if="category.children_count > 0"
          />
          <router-link
            v-else
            class="category-link"
            :to="localizedRoute({ name: 'category', params: { id: category.id, slug: category.slug }})"
          >
            
            {{ category.name }}
          </router-link>
        </div>

        <sub-category
          :category-links="category.children_data"
          :id="category.id"
          :parent-slug="category.slug"
          :parent-path="category.url_path"
        />
      </li>
      <li @click="closeMenu" v-if="isCurrentMenuShowed" class="border-b">
        <router-link
          class="menu-link"
          :to="localizedRoute('/sale')"
          exact
        >

          {{ $t('Sale') }}
        </router-link>
      </li>

      <li @click="closeMenu" v-if="isCurrentMenuShowed" class="border-b">
        <router-link
          class="menu-link"
          :to="localizedRoute('/brands')"
          exact
        >
          {{ $t('Brands') }}
        </router-link>
      </li>

      <!-- <li @click="closeMenu" v-if="isCurrentMenuShowed" class="border-b">
        <router-link
          class="menu-link"
          :to="localizedRoute('/magazine')"
          exact
        >
          
          {{ $t('Magazine') }}
        </router-link>
      </li> --> 
      <li @click="closeMenu" v-if="isCurrentMenuShowed" class="border-b md:hidden">
        <!-- <button
          class="menu-link text-left"
          type="button"
          @click="toggleSearchpanel"
        >
          {{ $t('Search') }}
        </button> -->
         <router-link
          class="menu-link"
          :to="localizedRoute('/search')"
          exact
        >
          {{ $t('Search') }}
        </router-link>
      </li>
      <li @click="closeMenu" v-if="compareIsActive && isCurrentMenuShowed" class="border-b">
        <router-link
          class="menu-link"
          :to="localizedRoute('/compare')"
          exact
        >
          {{ $t('Compare products') }}
        </router-link>
      </li>
      <!-- <li @click="closeMenu" v-if="isCurrentMenuShowed" class="border-b">
        <router-link
          class="menu-link"
          :to="localizedRoute('/order-tracking')"
          exact
        >
          {{ $t('Track my order') }}
        </router-link>
      </li> -->
      <li @click="closeMenu" class="flex border-b menu_li_it hide-item-full" >
        <sub-btn
          v-if="currentUser"
          :name="$t('My account')"
          class=""
        />
        <sub-category
          v-if="currentUser"
          :my-account-links="myAccountLinks"
          :id="'foo'"
        />
        <a
          v-if="!currentUser && isCurrentMenuShowed"
          href="#"
          @click.prevent="login"
          class="menu-link"
        >
          {{ $t('My account') }}
        </a>
      </li>
    </ul>
  </div>
</template>

<script>
import { mapState } from 'vuex'
import i18n from '@vue-storefront/i18n'

import SidebarMenu from '@vue-storefront/core/compatibility/components/blocks/SidebarMenu/SidebarMenu'
import { AccountButton } from '@vue-storefront/core/modules/user/components/AccountButton'
import SubBtn from 'theme/components/core/blocks/SidebarMenu/SubBtn'
import SubCategory from 'theme/components/core/blocks/SidebarMenu/SubCategory'
import NoScrollBackground from 'theme/mixins/noScrollBackground'

export default {
  components: {
    SubCategory,
    SubBtn
  },
  mixins: [SidebarMenu, AccountButton, NoScrollBackground],
  data () {
    return {
      myAccountLinks: [
        {
          id: 1,
          name: i18n.t('My profile'),
          url: '/my-account',
          icon: 'fas fa-user-alt'
        },
        {
          id: 2,
          name: i18n.t('My shipping details'),
          url: '/my-account/shipping-details',
          icon: 'fas fa-shipping-fast'
        },
        {
          id: 3,
          name: i18n.t('My newsletter'),
          url: '/my-account/newsletter',
          icon: 'fas fa-newspaper'
        },
        {
          id: 4,
          name: i18n.t('My orders'),
          url: '/my-account/orders',
          icon: 'fas fa-box'
        },
        {
          id: 5,
          name: i18n.t('My loyalty card'),
          url: '#',
          icon: 'fas fa-gift'
        },
        {
          id: 6,
          name: i18n.t('My product reviews'),
          url: '#',
          icon: 'fas fa-star-half-alt'
        },
        {
          id: 7,
          name: i18n.t('My Recently viewed products'),
          url: '/my-account/recently-viewed',
          icon: 'fas fa-star-half-alt'
        }
      ],
      componentLoaded: false
    }
  },
  computed: {
    mainListStyles () {
      return this.submenu.depth ? `transform: translateX(${this.submenu.depth * 100}%)` : false
    },
    ...mapState({
      submenu: state => state.ui.submenu,
      currentUser: state => state.user.current,
      isUserInAccountsPageFlag: state => state.ui.isUserInAccountsPage
    }),
    getSubmenu () {
      return this.submenu
    },
    visibleCategories () {
      return this.categories.filter(category => {
        return category.product_count > 0 || category.children_count > 0
      })
    },
    isCurrentMenuShowed () {
      return !this.getSubmenu || !this.getSubmenu.depth
    }
  },
  mounted () {
    this.$nextTick(() => {
      this.componentLoaded = true
    })
  },
  methods: {
    login () {
      this.$nextTick(() => {
        this.goToAccount()
      })
    },
    toggleSearchpanel () {
      this.$store.commit('ui/setSearchpanel', true)
    }
  }
}
</script>

<style lang="scss">
@import "~theme/css/animations/transitions";

@screen lg {
  .header-fixed .sidebar-menu {
    top: 70px;
    max-height: calc(100vh - 70px);
  }
}

.sidebar-menu {
  width: 100vh;
  top: 0px;
  left: 0;
  overflow: hidden;
  overflow-y: auto;
  z-index: 6;
  max-height: calc(100vh - 0px);

  @screen md {
    width: 350px;
  }

  @screen lg {
    top: 0;
    max-height: 100vh;
  }

  &__list {
    transition: transform $duration-main $motion-main;
  }

  ul {
    list-style-type: none;
  }

  .category-link {
    @apply block w-full px-5 py-4 text-black font-medium;
  }

  .menu-link {
    @apply block w-full px-5 py-4 text-grey-dark text-sm font-medium bg-grey-lighter;

    &:hover, &:focus {
      @apply text-black;
    }
  }
}

@media (min-width: 576px){

  .sidebar-menu__list{
      margin-bottom: 60px;
   }
  .sidebar-menu__list .menu_li_it .ico_main {
    float: left;
    margin-top: 1px;
    margin-right: 15px;
    width: 24px!important;
    height: auto!important;
  }
  .sidebar-menu__list .menu_li_it .btn-list_menu{
    text-align: left;
    display: inline-block;
  }
  .sidebar-menu__list .menu_li_it .vt-icon--sm{ float: right; margin-top: 3px;  }

}


@media (max-width: 576px) {
  .sidebar-menu__list{
    margin-bottom: 60px;
  }
  .sidebar-menu{
    z-index: 100;
  }
  .sidebar-menu__list .menu_li_it{
    position: relative;
    text-transform: uppercase;
  }
  .sidebar-menu__list .menu_li_it .ico_main{
    font-size:35px;
    position: absolute;
    left: 15px;
    top: 28px;
  }
  .sidebar-menu__list .menu_li_it .btn-list_menu{
    text-align: left;
    display: inline-block;
  }
  .sidebar-menu__list .menu_li_it .vt-icon--sm{ float: right; margin-top: 3px;  }

}

@media (max-width: 768px) {
    .hide-item-full {
      display: none;
    }
}

@media screen and (min-width: 768px) and (max-width: 2560px) {
    .hide-item-full {
       display: none;
    }
}


</style>
